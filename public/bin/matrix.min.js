function keyboard(a){let b={};b.value=a;b.isDown=!1;b.isUp=!0;b.press=void 0;b.release=void 0;b.downHandler=e=>{e.key===b.value&&(b.isUp&&b.press&&b.press(),b.isDown=!0,b.isUp=!1,e.preventDefault())};b.upHandler=e=>{e.key===b.value&&(b.isDown&&b.release&&b.release(),b.isDown=!1,b.isUp=!0,e.preventDefault())};const d=b.downHandler.bind(b),c=b.upHandler.bind(b);window.addEventListener("keydown",d,!1);window.addEventListener("keyup",c,!1);b.unsubscribe=()=>{window.removeEventListener("keydown",d);window.removeEventListener("keyup",
c)};return b}var Tools=Tools||{};Tools.availableSize={width:a=>Math.max(document.documentElement.clientWidth,window.innerWidth||0),height:a=>Math.max(document.documentElement.clientHeight,window.innerHeight||0)};Tools.randomBetween=function(a=-40,b=40){return Math.random()*(b-a)+a};Tools.rb=function(a=15){return!(Math.floor(Math.random()*a)>a/3)};
Tools.ajaxGet=function(a,b){var d=new XMLHttpRequest;d.open("GET",a);d.addEventListener("load",function(){200<=d.status&&400>d.status&&b(d.responseText)});d.addEventListener("error",function(){});d.send(null)};Tools.isMobile=function(){console.log(navigator.userAgent);let a=(new RegExp(/Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini|Mobile Safari/ig)).test(navigator.userAgent);console.log(a);return a};
function Sentence(a,b,d=!1){PIXI.Sprite.call(this);this.allChars=[];this.isCommand=d;let c=new PIXI.filters.NoiseFilter;c.blendMode=PIXI.BLEND_MODES.ADD;c.noise=.59;c.seed=.33;c.autoFit=!0;this.filters=[c];this.limitQuote=b;this.createSentence(a.toUpperCase(),d?0:5)}Sentence.prototype=Object.create(PIXI.Sprite.prototype);
Sentence.prototype.createSentence=function(a,b=5,d){let c=State.getInstance();const e=this;for(let f=0;f<a.length+1;f++){let h=f===a.length;setTimeout(()=>{let g=new Char(350+20*b,h?Math.floor(100*Math.random()):null,h?null:a[f]);g.x=Char.SIZE/2*f;g.y=-(Char.SIZE+5);e.addChild(g);e.allChars.push(g);createjs.Sound.play("frap_"+Math.ceil(4*Math.random()));f>this.limitQuote&&!h&&g.color(c.currentColor)},50*f)}};Sentence.prototype.update=function(){for(let a=0;a<this.allChars.length;a++)allChars[a].update()};
Sentence.prototype.removeChar=function(a){console.log("this.removeChar");var b=this.allChars.indexOf(a);-1<b&&this.allChars.splice(b,1);this.removeChild(a);a.destroy();0===this.allChars.length&&(this.isCommand?this.parent.deleteCommand(this):this.parent.deleteSentence(this))};
function Drop(){PIXI.Sprite.call(this);this.allChars=[];this.size=Math.max(Math.floor(20*Math.random())+10,Math.floor(50*Math.random()));this.cLength=300*Math.random()+50;this.createDropChar(this.size);this.state=State.getInstance();if(Tools.rb(5)){let a=new PIXI.filters.BlurFilter(Tools.randomBetween(0,20),3,3);a.blendMode=PIXI.BLEND_MODES.HARD_LIGHT;a.autoFit=!0;this.filters=[a]}}Drop.prototype=Object.create(PIXI.Sprite.prototype);Drop.prototype.update=function(){for(let a=0;a<this.allChars.length;a++)allChars[a].update()};
Drop.prototype.getSize=function(){return this.size};Drop.prototype.forceDelete=function(){for(let a=0;a<this.allChars.length;a++){const b=this.allChars[a];setTimeout(()=>{b.cycleLength=0},Tools.randomBetween(0,20)*a)}};Drop.prototype.removeChar=function(a){var b=this.allChars.indexOf(a);-1<b&&this.allChars.splice(b,1);this.removeChild(a);a.destroy();0===this.allChars.length&&this.parent.deleteDrop(this)};
Drop.prototype.createDropChar=function(a=1){let b=State.getInstance();const d=this;for(let c=0;c<a;c++)setTimeout(()=>{var e=Math.floor(200*Math.random())+100;e=new Char(d.cLength,200>e?e:null);e.y=c*(Char.SIZE-5);d.addChild(e);d.allChars.push(e);d.allChars[c-1]&&d.allChars[c-1].color(b.currentColor)},50*c)};
const State=function(){function a(){this.customColor="#dddddd";this.width=800;this.height=600;this.isMobile=Tools.isMobile();this.isLooping=this.isRandom=!0;this.allQuotes=[];this.colors=["#ed0039","#44b5ff","#7cfc00"];let d=new RegExp(/^#[a-f0-9]{6}/);d.test(window.location.hash.toLowerCase())&&(this.customColor=window.location.hash.toLowerCase(),this.colors.push(this.customColor));this.currentColor=d.test(window.location.hash.toLowerCase())?window.location.hash.toLowerCase():"#7cfc00";return{width:this.width,
height:this.height,colors:this.colors,isMobile:this.isMobile,isRandom:this.isRandom,isLooping:this.isLooping,currentColor:this.currentColor,customColor:this.customColor,allQuotes:this.allQuotes,getNewColor:function(){return this.currentColor=this.colors[Math.floor(Math.random()*this.colors.length)]},getNbRows:function(){return Math.floor(this.height/Char.SIZE)},getNbColumns:function(){return Math.floor(this.width/(Char.SIZE/2))},getNbDrop:function(c=!1){c&&console.log(this.width,Char.SIZE/2,Math.floor(this.width/
(Char.SIZE/2)));return Math.min(Math.floor(1.5*b.getNbColumns()),240)},getRandomY:function(){return Math.floor(Math.random()*Math.floor(this.height/Char.SIZE)/2)*(Char.SIZE-5)},getRandomQuote:function(){let c=this.getQuote();for(console.log(this.getNbColumns());(c.quote+" "+c.author).length>this.getNbColumns();)c=this.getQuote();return c},getQuote:function(){console.log(this.allQuotes);let c=this.allQuotes.length,e=Math.floor(Math.random()*c),f=this.allQuotes[e];console.log("getQuote",c,e,f);return f},
setCurrentColor:function(c){this.currentColor=c;location.hash=this.currentColor}}}var b;return{getInstance:function(){b||=a();return b}}}();function Char(a,b=null,d=null){this.fps=b;this.currentCount=0;this.chara=d?d:this.getRandomChar();PIXI.extras.BitmapText.call(this,this.chara,{font:`${Char.SIZE}px matrix`,tint:"0xffffff"});this.cycle=0;this.cycleLength=a;this.state=State.getInstance()}Char.prototype=Object.create(PIXI.extras.BitmapText.prototype);Char.SIZE=20;Char.ALL="abcdefghijklmnopqrstuvwxyz1234567890$+-*/=%\"'#&_(),.;:?!\\|{}<>[]^~ABCDEFGHIJKLMNOPQRSTUVWXYZ".split("");
Char.prototype.getRandomChar=function(){return Char.ALL[Math.floor(Math.random()*Char.ALL.length)]};Char.prototype.color=function(a){this.dirty=!0;this._font.tint=a.replace("#","0x")};
Char.prototype.update=function(){this.cycle++;if(this.cycle>=this.cycleLength)this.cycle=0,this.parent.removeChar(this);else{var a=`${this.state.currentColor}`.replace("#","0x");this._font.tint!=a&&"0xffffff"!=this._font.tint&&(this.dirty=!0,this._font.tint=a);null!==this.fps&&(this.currentCount++,this.currentCount>=this.fps&&(this.currentCount=0,this.dirty=!0,this.text=this.getRandomChar()))}};
function Matrix(a){PIXI.Sprite.call(this);this.stage=a;this.state=State.getInstance();this.trameMap=new PIXI.Sprite(PIXI.Texture.fromImage("trame"));this.trameMap.blendMode=PIXI.BLEND_MODES.MULTIPLY;this.stage.addChild(this);this.stage.addChild(this.trameMap);this.rain=[];this.sentence=null;this.glitchCount=this.colorCount=0;this.glitchTrigger=350;this.glitchFilter=this.createGlitchEffect(this.trameMap);this.filters=[this.glitchFilter];this.createRain();this.initEvents();this.activateEvents()}
Matrix.prototype=Object.create(PIXI.Sprite.prototype);
Matrix.prototype.createGlitchEffect=function(a){var b=document.getElementById("shader").innerHTML;b=new PIXI.Filter(null,b);b.displacementMap=a;b.autoFit=!0;b.blendMode=PIXI.BLEND_MODES.HARD_LIGHT;b.padding=0;b.enabled=!1;b.uniforms.aspect=1;b.uniforms.cosDir=.33;b.uniforms.fillMode=2;b.uniforms.blue=new Float32Array([10,-4]);b.uniforms.red=new Float32Array([2,2]);b.uniforms.green=new Float32Array([-10,4]);b.uniforms.dimensions=new Float32Array([this.state.width,this.state.height]);b.uniforms.seed=
.5;b.uniforms.offset=100;return b};Matrix.prototype.createRain=function(){let a=State.getInstance().getNbDrop();for(let b=0;b<a;b++)setTimeout(()=>{this.addDrop()},150*Math.random()*b)};Matrix.prototype.addDrop=function(){if(this.state.isLooping&&this.rain.length<this.state.getNbColumns()){let a=new Drop;this.addChild(a);a.x=Math.floor(Math.random()*this.state.getNbColumns())*Char.SIZE/2;a.y=this.state.getRandomY();this.rain.push(a)}};
Matrix.prototype.activateEvents=function(){this.stage.interactive=!0};Matrix.prototype.deactivateEvents=function(){this.stage.interactive=!1};Matrix.prototype.initEvents=function(){this.stage.on(this.state.isMobile?"pointertap":"click",()=>{this.actionTrigger(this.state.getRandomQuote())})};Matrix.prototype.actionTrigger=function(a){const b=this;createjs.Sound.play("drop");this.deleteForce();this.deactivateEvents();setTimeout(()=>{b.addSentence(a)},1E3)};
Matrix.prototype.addCommand=function(a){this.command&&(this.removeChild(this.command),this.command.destroy(),this.command=null);a=new Sentence(a+" INFO",a.length,!0);a.x=5;a.y=25;this.addChild(a);console.log(a);this.command=a};Matrix.prototype.deleteCommand=function(a){console.log("this.deleteCommand");this.removeChild(a);a.destroy();this.command=null};
Matrix.prototype.addSentence=function(a){let b=a.quote+" "+a.author;a=new Sentence(b,a.quote.length);a.x=Math.floor((this.state.getNbColumns()-b.length)/2)*(Char.SIZE/2);a.y=(Math.floor(this.state.getNbRows()/2)-1)*Char.SIZE;this.addChild(a);console.log(a);this.sentence=a};Matrix.prototype.deleteSentence=function(a){this.sentence=null;this.removeChild(a);a.destroy();setTimeout(()=>{this.createRain();this.activateEvents();this.state.isLooping=!0},Tools.randomBetween(100,1E3))};
Matrix.prototype.deleteDrop=function(a){var b=this.rain.indexOf(a);-1<b&&(this.rain.splice(b,1),this.removeChild(a),a.destroy());this.state.isLooping&&this.addDrop()};Matrix.prototype.deleteForce=function(){this.state.isLooping=!1;for(let a=0;a<this.rain.length;a++)this.rain[a].forceDelete()};
Matrix.prototype.update=function(){const a=this;this.sentence&&this.sentence.update();this.command&&this.command.update();for(let b=0;b<this.rain.length;b++)this.rain[b].update();this.colorCount++;500<=this.colorCount&&(this.colorCount=0,this.state.isRandom||this.state.getNewColor());this.glitchCount++;this.glitchCount>=this.glitchTrigger&&(this.glitchTrigger=Math.floor(650*Math.random())+100,this.glitchCount=0,this.updateGlitch(),this.glitchFilter.enabled=!0,setTimeout(()=>{a.glitchFilter.enabled=
!1;a.updateGlitch();setTimeout(()=>{a.glitchFilter.enabled=!0;setTimeout(()=>{a.glitchFilter.enabled=!1;a.glitchCount=0},250*Math.random())},100*Math.random())},500*Math.random()))};
Matrix.prototype.updateGlitch=function(){this.glitchFilter.uniforms.blue=new Float32Array([Tools.randomBetween(),Tools.randomBetween()]);this.glitchFilter.uniforms.red=new Float32Array([Tools.randomBetween(),Tools.randomBetween()]);this.glitchFilter.uniforms.green=new Float32Array([Tools.randomBetween(),Tools.randomBetween()]);this.glitchFilter.uniforms.dirCos=Math.cos(360*Math.random())};
function Main(a){this.view=document.getElementById("game-canvas");this.stage=new PIXI.Container;this.state=State.getInstance();this.state.allQuotes=a;this.renderer=PIXI.autoDetectRenderer(this.state.width,this.state.height,{view:this.view});this.renderer.backgroundColor=0;a=new PIXI.Sprite(PIXI.Texture.WHITE);a.width=this.state.width;a.height=this.state.height;a.tint=0;this.stage.addChild(a);this.loadSpriteSheet()}
Main.prototype.update=function(){this.matrix.update();this.renderer.render(this.stage);requestAnimationFrame(this.update.bind(this))};Main.prototype.loadSpriteSheet=function(){var a=PIXI.loader;a.add("matrix","./assets/matrix.fnt");a.add("trame","./assets/trame.jpg");a.once("complete",this.spriteSheetLoaded.bind(this));a.load()};
Main.prototype.spriteSheetLoaded=function(){const a=this;this.view.style.visibility="visible";this.matrix=new Matrix(this.stage,this.state);this.addKeysEvents();requestAnimationFrame(this.update.bind(this));setTimeout(()=>{a.matrix.actionTrigger({quote:"What is the Matrix",author:"neo"})},100);this.state.isMobile||this.matrix.addCommand("PRESS R V B C SPACE OR CLICK")};
Main.prototype.addKeysEvents=function(){console.log("adding key Events r, v, b, c, (Red, Blue, Green, Custom)");this.keyRed=keyboard("r");this.keyGreen=keyboard("v");this.keyBlue=keyboard("b");this.keyCustom=keyboard("c");this.keyRandom=keyboard(" ");this.keyRed.press=()=>{console.log("Red pressed");this.matrix.addCommand("RED");this.state.setCurrentColor(this.state.colors[0])};this.keyBlue.press=()=>{console.log("blue pressed");this.matrix.addCommand("BLUE");this.state.setCurrentColor(this.state.colors[1])};
this.keyGreen.press=()=>{console.log("Green pressed");this.matrix.addCommand("GREEN");this.state.setCurrentColor(this.state.colors[2])};this.keyCustom.press=()=>{console.log("Custom pressed");this.matrix.addCommand("CUSTOM COLOR");this.state.setCurrentColor(this.state.customColor)};this.keyRandom.press=()=>{console.log("Random pressed");this.state.isRandom=!this.state.isRandom;this.matrix.addCommand(`RANDOM ${this.state.isRandom?"DEACTIVATED":"ACTIVATED"}`)}};
